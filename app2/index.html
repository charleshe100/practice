<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>學生資料管理系統</title>
    <link rel="shortcut icon" href="#" type="image/x-icon">
    <link rel="stylesheet" href="../css/bootstrap.css">
    <link rel="stylesheet" href="style.css">
    <!---匯入要使用的函式庫--->
    <script src="jquery.js"></script>  
    <script src="../js/bootstrap.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />  
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <style>          
      #add{
        z-index: 5000;
      }
      .flatpickr-calendar {
          z-index: 100000; /* 確保日期選擇器在 modal 之上 */
      }
    </style>
</head>
<body>  
    <h1 class="header fw-bolder">學生資料管理系統
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add">
        <i class="fa-solid fa-user-plus"></i> 新增
      </button>
    </h1>
    <div class="container d-flex">
      <div class="all mx-2 my-3 col-1">
        <button data-type="all" class="btn btn-warning mx-2 my-2" onclick="queryAll()" id="allbtn">全部</button>
      </div>
      <div class="sex mx-2 my-3 col-2">
        <!-- <button class="btn btn-primary mx-2 my-2" onclick="query('sex=1')">男生</button> -->
        <!-- <button class="btn btn-danger mx-2 my-2" onclick="query('sex=2')">女生</button> -->
        <button data-type="boy" class="btn btn-primary mx-2 my-2" onclick="query('sex','1')" id="boybtn">男生</button>
        <button data-type="girl" class="btn btn-danger mx-2 my-2" onclick="query('sex','2')" id="girlbtn">女生</button>
      </div>
      <div class="classes mx-2 my-3">
      </div>
    </div>
    <div class="users d-flex flex-wrap justify-content-center mx-auto my-3 w-75"></div>

  <!-- Modal -->
  <div class="modal fade" id="add" tabindex="-1" aria-labelledby="addLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="addLabel"><h2>新增學生資料</h2></h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="./api/insert.php" method="post">
            <div class="input-group mb-3">
              <!-- <label for="name" class="form-label">姓名</label> -->
              <span class="input-group-text">姓名</span>
              <input type="text" class="form-control" name="name" id="name" placeholder="王小明">
            </div>            
            <div class="input-group mb-3">
              <span class="input-group-text">學號</span>
              <input type="text" class="form-control" name="school_num" id="school_num" placeholder="911001">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">身份證字號</span>
              <input type="text" class="form-control" name="uni_id" id="uni_id" placeholder="A123456789">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">生日</span>
              <input type="date" class="form-control" name="birthday" id="birthday" placeholder="2018-01-01">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">電話</span>
              <input type="text" class="form-control" name="tel" id="tel" placeholder="02-12345678">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">地址</span>
              <input type="text" class="form-control" name="addr" id="addr" placeholder="台北市大安區大安路1號">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">家長</span>
              <input type="text" class="form-control" name="parents" id="parents" placeholder="王大明">
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">科系</span>              
              <!-- <input type="text" class="form-control" name="dept" id="dept" placeholder="商業經營科"> -->
              <div class="form-floating" id="floatingSelect1" aria-label="Floating label select example">
                <select class="form-select" id="deptSelect" name="dept">
                  <!-- <option selected>請選擇</option> -->                
                </select>
              <label for="floatingSelect">下拉選單</label>
              </div>
            </div>
            <div class="input-group mb-3">
              <span class="input-group-text">畢業學校</span>
              <!-- <input type="text" class="form-control" name="graduate_at" id="graduate_at" placeholder="縣立仁愛國中"> -->
              <div class="form-floating d-flex" id="floatingSelect2" aria-label="Floating label select example">
                <!-- 分兩個select -->
                <!-- <select class="form-select" id="graduateSelect1">
                </select>
                <select class="form-select" id="graduateSelect2">
                </select> -->
                <select class="form-select" id="graduateSelect" name="graduate_at">
                </select>
              <label for="floatingSelect">下拉選單</label>
              </div>
            </div>
            <div class="row d-flex">
              <div class="col-6">
            <div class="input-group mb-3">
              <span class="input-group-text">狀態</span>              
              <div class="form-floating" id="floatingSelect3" aria-label="Floating label select example">
                <select class="form-select" id="statusSelect" name="status_code">
                  <!-- <option selected>請選擇</option> -->                
                </select>
              <label for="floatingSelect">下拉選單</label>
              </div>
            </div>
            </div>
            <div class="col-6">
            <div class="input-group mb-3">
              <span class="input-group-text">班級</span>              
              <div class="form-floating" id="floatingSelect4" aria-label="Floating label select example">
                <select class="form-select" id="classcodeSelect" name="class_code">
                  <!-- <option selected>請選擇</option> -->                
                </select>
              <label for="floatingSelect">下拉選單</label>
              </div>
            </div>
            </div>
            </div>
            <div class="row d-flex">
              <div class="col-6">
            <div class="input-group mb-3">
              <span class="input-group-text">座號</span>              
              <div class="form-floating" id="floatingSelect5" aria-label="Floating label select example">
                <select class="form-select" id="seatnumSelect" name="seat_num">
                  <!-- <option selected>請選擇</option> -->                
                </select>
              <label for="floatingSelect">下拉選單</label>
              </div>
            </div>
            </div>            
            <div class="col-6">
            <div class="input-group mb-3">
              <span class="input-group-text">學年</span>
              <input type="text" class="form-control" name="year" id="year" placeholder="2000">
            </div>
            </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
            </div>                
          </form>
        </div>
        
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
//flatpickr日期
$(document).ready(function(){
  $('#add').on('shown.bs.modal',function(){
    $('#birthday').flatpickr({
      dateFormat: "Y-m-d",
      altInput: true,
      altFormat: "F j, Y",
      allowInput: true
    });
  });
});
/************************************
* 1.考慮觸發行為的事件
* 2.建立監聽行為
* 3.考慮是否需要代入參數
* 4.是否會有回傳值？回傳值的功用及處理？
* 5.是否需要更新畫面內容？更新畫面的方法？
************************************/

queryAll();
queryClasses();

function create(){

}

function btnsecondary(){
    $("#allbtn").removeClass('btn-warning').addClass('btn-secondary');
    $("#boybtn").removeClass('btn-primary').addClass('btn-secondary');
    $("#girlbtn").removeClass('btn-danger').addClass('btn-secondary');
    $(".classbtn").removeClass('btn-success').addClass('btn-secondary');
  } 
//這段事件綁定只會在頁面初次加載時對已存在的按鈕進行綁定，對後來動態生成的按鈕無效
// $("#allbtn, #boybtn, #girlbtn, .classbtn").click(function(){   
//改成利用 jQuery 的事件委派機制，將事件綁定到一個常駐的父元素上，從而讓動態生成的子元素也能觸發事件
  $(document).on('click', '#allbtn, #boybtn, #girlbtn, .classbtn', function(){
  let type = $(this).data('type');
  // let value = $(this).data('value');
  switch(type){
    case 'all':
      btnsecondary();
      $(this).removeClass('btn-secondary').addClass('btn-warning');
    break;
    case 'boy':
      btnsecondary()
      $(this).removeClass('btn-secondary').addClass('btn-primary');
    break;
    case 'girl':
      btnsecondary()
      $(this).removeClass('btn-secondary').addClass('btn-danger');
    break;
    case 'class':
      btnsecondary()
      $(this).removeClass('btn-secondary').addClass('btn-success');
    break;
  }
})

// show.bs.modal 去查bs5的modal的events
// on 是觸發，當觸發的時候，就做以下事情
$("#add").on('show.bs.modal',()=>{
  $.get("./api/dept.php",(options)=>{
    $("#deptSelect").html(options)
  })
})

//分兩個select
// $("#add").on('show.bs.modal',function(){
//   $.get("./api/graduateSchool.php", function(data) {
//         let options = data.split(","); // 根據分隔符分割返回的數據
//         $("#graduateSelect1").html(options[0]);
//         $("#graduateSelect2").html(options[1]);
//     });
// })

// 整合成一個select
$("#add").on('show.bs.modal',()=>{
  $.get("./api/graduateSchool.php",(options)=>{
    $("#graduateSelect").html(options)
  })
})

$("#add").on('show.bs.modal',()=>{
  $.get("./api/status.php",(options)=>{
    $("#statusSelect").html(options)
  })
})

$("#add").on('show.bs.modal',()=>{
  $.get("./api/classes.php",(options)=>{
    $("#classcodeSelect").html(options)
  })
})

$("#add").on('show.bs.modal',()=>{
  $.get("./api/classStudent.php",(options)=>{
    $("#seatnumSelect").html(options)
  })
})




function render(users){
  console.log(users) 
    //先清空，後面才能再放進user_layout 
    $(".users").empty();
    let user_layout;
    users.forEach((user,idx)=>{
      user_layout=`<div class="p-2" id="user${user.id}">
      <div class="card" style="width: 12rem;">
      <div class='name text-center fw-bolder fs-5 mt-2'>${user.name}</div>
        <div class="card-body">
          <div class="card-text">${user.school_num}</div>
          <div class="card-text">${user.birthday}</div>
          <div class="card-text">${user.uni_id}</div>
          <div class='controls mt-2'>
            <a href="#" class="btn btn-primary">編輯</a>
            <a href="Javascript:del(${user.id})" class="btn btn-secondary">刪除</a>
          </div>
        </div>
      </div>
      </div>`
    
      $(".users").append(user_layout)
    })
}

function query(type,value){  
  $.get(`./api/query.php?do=${type}`,{value},(users)=>{    
    render(users)
  })
}

//查詢所有的資料
function queryAll(){
$.get("./api/query.php?do=all",(users)=>{ 
  render(users)
})
}

function queryClasses(){
  $.get("./api/query.php?do=classes",(classes)=>{
    console.log(classes);
    let class_btns
    classes.forEach((c,idx)=>{
      class_btns=`<button data-type="class" class="classbtn btn btn-success mx-2 my-2" onclick="query('class','${c.code}')">${c.name}</button>`
    $(".classes").append(class_btns)
    })

  })
}
//編輯資料的函式
function update(){

}

//刪除資料的函式
function del(id){
  // alert("確定要刪除嗎？")
  // prompt("確定要刪除嗎？")
  let con=confirm("確定要刪除嗎？")
  if(con){
    $.post(("./api/delete.php"),{id},(res)=>{
      // 方法一：重整，再次跟後端要資料，會增加流量
      //  queryAll()
      // 方法二：直接移除html，不用跟後端要資料，資料小很多
      $(`#user${id}`).remove()
      // window.location.href="./api/delete.php";
      })
    alert("資料已刪除！")
  }
}
</script>
</body>
</html>